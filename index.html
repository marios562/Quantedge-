<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>QuantEdge â€” AI-Powered Stock Screener</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4fffb0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="QuantEdge">
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;700&display=swap');
:root{--bg:#06080f;--surface:#0c0f1a;--surface2:#131829;--surface3:#1a2035;--border:#1f2640;--border2:#2a3356;--text:#e2e8f8;--text-dim:#6b7799;--text-muted:#2e3a5c;--accent:#4fffb0;--accent2:#00d4ff;--warn:#ffb547;--danger:#ff4d6d;--grade-aplus:#00ff87;--grade-a:#4fffb0;--grade-b:#7dd8ff;--grade-c:#ffda6b;--grade-d:#ff9248;--grade-f:#ff4d6d;--glow:rgba(79,255,176,0.12)}
*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0}
.orb{position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none;z-index:0;animation:float 20s ease-in-out infinite}
.orb1{width:500px;height:500px;background:radial-gradient(circle,rgba(79,255,176,0.04),transparent);top:-150px;left:-150px}
.orb2{width:400px;height:400px;background:radial-gradient(circle,rgba(0,212,255,0.04),transparent);bottom:-100px;right:-100px;animation-delay:-8s}
.orb3{width:300px;height:300px;background:radial-gradient(circle,rgba(255,181,71,0.03),transparent);top:40%;left:50%;animation-delay:-14s}
@keyframes float{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(30px,-30px) scale(1.05)}66%{transform:translate(-20px,20px) scale(0.96)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes splashPulse{0%,100%{box-shadow:0 0 0 0 rgba(79,255,176,0.4)}50%{box-shadow:0 0 0 20px rgba(79,255,176,0)}}
@keyframes splashLoad{from{width:0%}to{width:100%}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.app{position:relative;z-index:1;max-width:1300px;margin:0 auto;padding:0 24px 80px}
nav{display:flex;align-items:center;justify-content:space-between;padding:24px 0 20px;border-bottom:1px solid var(--border);margin-bottom:48px}
.logo{display:flex;align-items:center;gap:10px;font-size:1.3rem;font-weight:800;letter-spacing:-0.02em;color:#fff}
.logo-dot{width:28px;height:28px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.nav-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.nav-badge{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);border:1px solid var(--border);padding:4px 10px;border-radius:20px;letter-spacing:0.1em}
.nav-date{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);border:1px solid rgba(79,255,176,0.3);padding:4px 10px;border-radius:20px;letter-spacing:0.05em}
.hero{margin-bottom:48px;animation:fadeUp 0.6s ease both}
.hero h1{font-size:clamp(2rem,4vw,3.2rem);font-weight:800;letter-spacing:-0.03em;line-height:1.1;color:#fff;margin-bottom:12px}
.hero h1 em{font-style:normal;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero p{color:var(--text-dim);font-size:15px;max-width:560px;line-height:1.6}
.search-wrap{display:flex;gap:12px;margin-bottom:40px;animation:fadeUp 0.6s 0.1s ease both}
.search-box{flex:1;display:flex;align-items:center;background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:0 18px;gap:12px;transition:border-color 0.2s,box-shadow 0.2s}
.search-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,255,176,0.08)}
.search-box span{color:var(--text-dim);font-size:16px}
.search-box input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:15px;padding:16px 0;text-transform:uppercase;letter-spacing:0.1em}
.search-box input::placeholder{color:var(--text-muted);text-transform:none;letter-spacing:0}
.btn-analyze{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:12px;padding:0 28px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:#06080f;cursor:pointer;letter-spacing:0.05em;transition:transform 0.15s,box-shadow 0.15s;white-space:nowrap;min-height:54px}
.btn-analyze:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(79,255,176,0.25)}
.presets{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:48px;animation:fadeUp 0.6s 0.15s ease both}
.chip{font-family:'JetBrains Mono',monospace;font-size:11px;padding:6px 14px;border:1px solid var(--border2);border-radius:20px;color:var(--text-dim);cursor:pointer;transition:all 0.15s;background:var(--surface);letter-spacing:0.05em}
.chip:hover,.chip.active{border-color:var(--accent);color:var(--accent);background:var(--glow)}
.score-header{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:24px;background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:28px 32px;margin-bottom:24px;animation:fadeUp 0.5s ease both}
.ticker-info .ticker{font-size:2rem;font-weight:800;color:#fff;letter-spacing:-0.02em}
.ticker-info .name{font-size:13px;color:var(--text-dim);margin-top:2px}
.ticker-info .sector{display:inline-block;margin-top:6px;font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 8px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);letter-spacing:0.1em}
.overall-score{text-align:center}
.score-circle{width:90px;height:90px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto 6px;position:relative}
.score-circle::before{content:'';position:absolute;inset:-3px;border-radius:50%;background:conic-gradient(var(--accent) var(--pct,0%),var(--surface3) 0%);z-index:-1}
.score-circle::after{content:'';position:absolute;inset:4px;border-radius:50%;background:var(--surface);z-index:-1}
.score-num{font-size:1.8rem;font-weight:800;color:#fff;line-height:1}
.score-max{font-size:10px;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.score-label{font-size:11px;color:var(--text-dim);letter-spacing:0.1em}
.price-info{text-align:right}
.price-info .price{font-family:'JetBrains Mono',monospace;font-size:1.8rem;font-weight:700;color:#fff}
.price-info .change{font-family:'JetBrains Mono',monospace;font-size:13px;margin-top:4px}
.change.up{color:var(--accent)}.change.down{color:var(--danger)}
.price-info .mkt-cap{font-size:12px;color:var(--text-dim);margin-top:6px}
.live-badge{display:inline-flex;align-items:center;gap:5px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);margin-top:6px;letter-spacing:0.08em}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:livePulse 1.5s ease infinite}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:0.3}}
.rec-badge{display:inline-block;margin-top:10px;padding:5px 16px;border-radius:6px;font-size:12px;font-weight:700;letter-spacing:0.08em}
.rec-strong-buy{background:rgba(79,255,176,0.12);color:var(--accent);border:1px solid rgba(79,255,176,0.3)}
.rec-buy{background:rgba(125,216,255,0.12);color:var(--accent2);border:1px solid rgba(125,216,255,0.3)}
.rec-hold{background:rgba(255,218,107,0.12);color:var(--warn);border:1px solid rgba(255,218,107,0.3)}
.rec-sell{background:rgba(255,77,109,0.12);color:var(--danger);border:1px solid rgba(255,77,109,0.3)}
.factor-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:32px}
.factor-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px 18px;cursor:pointer;transition:border-color 0.2s,transform 0.15s,box-shadow 0.2s;animation:fadeUp 0.5s ease both}
.factor-card:hover{transform:translateY(-2px);border-color:var(--border2);box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.factor-card.active-card{border-color:var(--accent);box-shadow:0 0 0 1px rgba(79,255,176,0.2)}
.factor-icon{font-size:20px;margin-bottom:10px}
.factor-name{font-size:11px;color:var(--text-dim);letter-spacing:0.08em;margin-bottom:10px;font-weight:600}
.grade-badge{font-family:'JetBrains Mono',monospace;font-size:1.6rem;font-weight:700;line-height:1}
.grade-score{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:4px}
.gAp{color:var(--grade-aplus)}.gA{color:var(--grade-a)}.gB{color:var(--grade-b)}.gC{color:var(--grade-c)}.gD{color:var(--grade-d)}.gF{color:var(--grade-f)}
.detail-panel{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:28px 32px;margin-bottom:32px;display:none;animation:fadeUp 0.4s ease both}
.detail-panel.visible{display:block}
.detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.detail-header h3{font-size:1rem;font-weight:700;color:#fff}
.close-btn{background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text-dim);padding:4px 10px;cursor:pointer;font-size:13px;transition:all 0.15s}
.close-btn:hover{border-color:var(--border2);color:var(--text)}
.metrics-table{width:100%;border-collapse:collapse}
.metrics-table tr{border-bottom:1px solid rgba(255,255,255,0.03)}
.metrics-table tr:hover{background:rgba(255,255,255,0.02)}
.metrics-table td{padding:11px 12px;font-size:13px}
.metrics-table td:first-child{color:var(--text-dim)}
.metrics-table td:nth-child(2){font-family:'JetBrains Mono',monospace;color:var(--text);text-align:right}
.metrics-table td:nth-child(3){font-family:'JetBrains Mono',monospace;font-size:11px;text-align:right;color:var(--text-dim)}
.metrics-table td:nth-child(4){text-align:right}
.mini-bar-wrap{display:flex;align-items:center;gap:8px;justify-content:flex-end}
.mini-bar-track{background:var(--surface3);border-radius:2px;height:4px;width:80px;overflow:hidden}
.mini-bar-fill{height:100%;border-radius:2px;transition:width 0.8s cubic-bezier(0.16,1,0.3,1)}
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:32px}
.chart-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px}
.chart-panel h4{font-size:11px;font-weight:600;letter-spacing:0.12em;color:var(--text-dim);text-transform:uppercase;margin-bottom:20px}
canvas{display:block}
.compare-section{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px 32px;margin-bottom:32px}
.compare-section h4{font-size:12px;letter-spacing:0.1em;color:var(--text-dim);margin-bottom:16px}
.compare-row{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center}
.compare-stock{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 18px;cursor:pointer;transition:border-color 0.15s}
.compare-stock:hover{border-color:var(--accent2)}
.vs-badge{text-align:center;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:0.1em}
::-webkit-scrollbar{width:6px;background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.loading-bar{position:fixed;top:0;left:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;z-index:999;transition:width 0.4s ease,opacity 0.3s ease}
.method-note{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:0 12px 12px 0;padding:16px 20px;font-size:13px;color:var(--text-dim);line-height:1.7;margin-bottom:32px}
.method-note strong{color:var(--text)}
.splash{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;z-index:9999;transition:opacity 0.5s ease,visibility 0.5s ease}
.splash.hidden{opacity:0;visibility:hidden;pointer-events:none}
.splash-logo{width:72px;height:72px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;animation:splashPulse 1.5s ease infinite}
.splash h2{font-size:1.4rem;font-weight:800;color:#fff}
.splash p{font-size:12px;color:var(--text-dim);letter-spacing:0.15em}
.splash-bar{width:120px;height:2px;background:var(--border);border-radius:1px;overflow:hidden;margin-top:8px}
.splash-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));animation:splashLoad 1.4s ease forwards}
.offline-toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);background:rgba(255,77,109,0.12);border:1px solid rgba(255,77,109,0.4);border-radius:10px;padding:10px 20px;font-size:13px;color:var(--danger);z-index:1001;transition:transform 0.3s ease;white-space:nowrap}
.offline-toast.visible{transform:translateX(-50%) translateY(0)}
.install-banner{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(120px);width:calc(100% - 48px);max-width:480px;background:var(--surface2);border:1px solid var(--accent);border-radius:16px;padding:16px 20px;display:flex;align-items:center;gap:14px;z-index:1000;box-shadow:0 8px 40px rgba(0,0,0,0.6);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1)}
.install-banner.visible{transform:translateX(-50%) translateY(0)}
.install-banner .ib-icon{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.install-banner .ib-text{flex:1}
.install-banner .ib-text strong{display:block;font-size:13px;color:#fff;margin-bottom:2px}
.install-banner .ib-text span{font-size:11px;color:var(--text-dim)}
.install-banner .ib-actions{display:flex;gap:8px;flex-shrink:0}
.btn-install{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:8px;padding:8px 16px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:#06080f;cursor:pointer;white-space:nowrap}
.btn-dismiss-install{background:none;border:1px solid var(--border2);border-radius:8px;padding:8px 10px;font-size:11px;color:var(--text-dim);cursor:pointer}
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(12,15,26,0.96);backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:10px 0 calc(10px + env(safe-area-inset-bottom));z-index:100}
.bottom-nav-items{display:flex;justify-content:space-around}
.bnav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:4px 16px;cursor:pointer;color:var(--text-dim);transition:color 0.15s;border:none;background:none;font-family:'Syne',sans-serif}
.bnav-item.active{color:var(--accent)}
.bnav-item span:first-child{font-size:18px}
.bnav-item span:last-child{font-size:9px;letter-spacing:0.05em;font-weight:600}

/* â”€â”€ Dynamic Screener â”€â”€ */
.screener-wrap{margin-bottom:48px;animation:fadeUp 0.6s 0.15s ease both}
.screener-tabs{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.screener-tab{font-family:'JetBrains Mono',monospace;font-size:10px;padding:6px 14px;border:1px solid var(--border2);border-radius:20px;color:var(--text-dim);cursor:pointer;transition:all 0.15s;background:var(--surface);letter-spacing:0.06em;white-space:nowrap}
.screener-tab:hover{border-color:var(--border2);color:var(--text)}
.screener-tab.active{border-color:var(--accent);color:var(--accent);background:var(--glow)}
.screener-tab.tab-gainers.active{border-color:var(--grade-a);color:var(--grade-a);background:rgba(79,255,176,0.07)}
.screener-tab.tab-losers.active{border-color:var(--danger);color:var(--danger);background:rgba(255,77,109,0.07)}
.screener-tab.tab-actives.active{border-color:var(--accent2);color:var(--accent2);background:rgba(0,212,255,0.07)}
.screener-tab.tab-sp500.active{border-color:var(--warn);color:var(--warn);background:rgba(255,181,71,0.07)}
.screener-chips{display:flex;gap:7px;flex-wrap:wrap;min-height:36px;align-items:center;max-height:200px;overflow-y:auto;padding:4px 0}
.screener-chip{font-family:'JetBrains Mono',monospace;font-size:11px;padding:5px 13px;border:1px solid var(--border2);border-radius:20px;color:var(--text-dim);cursor:pointer;transition:all 0.15s;background:var(--surface);letter-spacing:0.04em;display:flex;align-items:center;gap:6px;white-space:nowrap}
.screener-chip:hover{border-color:var(--accent);color:var(--accent);background:var(--glow)}
.screener-chip.active{border-color:var(--accent);color:var(--accent);background:var(--glow)}
.chip-change{font-size:10px;opacity:0.85}
.chip-change.up{color:var(--grade-a)}
.chip-change.down{color:var(--danger)}
.screener-loading{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-muted);letter-spacing:0.08em;padding:6px 0}
.screener-label{font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;letter-spacing:0.1em;align-self:center;flex-shrink:0}
/* sp500 search */
.sp500-search{width:100%;background:var(--surface);border:1px solid var(--border2);border-radius:8px;padding:8px 14px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;margin-bottom:10px;letter-spacing:0.05em}
.sp500-search::placeholder{color:var(--text-muted)}
.sp500-search:focus{border-color:var(--accent)}
/* data freshness badge */
.data-age{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);letter-spacing:0.06em;padding:3px 8px;border:1px solid var(--border);border-radius:20px;display:inline-flex;align-items:center;gap:4px}

@media(max-width:900px){.factor-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:700px){.charts-row{grid-template-columns:1fr}}
@media(max-width:600px){
  .bottom-nav{display:block}
  .app{padding-bottom:calc(90px + env(safe-area-inset-bottom))}
  nav{padding-top:calc(24px + env(safe-area-inset-top))}
  .hero h1{font-size:1.8rem}
  .score-header{grid-template-columns:1fr 1fr}
  .score-header .ticker-info{grid-column:1/-1}
  .search-wrap{flex-direction:column}
  .btn-analyze{padding:16px;width:100%}
  .factor-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="loading-bar" id="loadingBar"></div>
<div class="splash" id="splash">
  <div class="splash-logo">âš¡</div>
  <h2>QuantEdge</h2>
  <p>AI STOCK RATINGS â€” LIVE DATA</p>
  <div class="splash-bar"><div class="splash-bar-fill"></div></div>
</div>
<div class="offline-toast" id="offlineToast">ğŸ“¡ Offline â€” ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ cached Î´ÎµÎ´Î¿Î¼Î­Î½Î±</div>
<div class="install-banner" id="installBanner">
  <div class="ib-icon">âš¡</div>
  <div class="ib-text">
    <strong>Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎµ Ï„Î¿ QuantEdge</strong>
    <span>Î ÏÏŒÏƒÎ²Î±ÏƒÎ· Ï‡Ï‰ÏÎ¯Ï‚ browser â€” ÏƒÎ±Î½ native app</span>
  </div>
  <div class="ib-actions">
    <button class="btn-install" id="btnInstall">Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</button>
    <button class="btn-dismiss-install" onclick="dismissInstall()">âœ•</button>
  </div>
</div>
<div class="bottom-nav">
  <div class="bottom-nav-items">
    <button class="bnav-item active" onclick="bnav('home',this)"><span>ğŸ“Š</span><span>SCREEN</span></button>
    <button class="bnav-item" onclick="bnav('watchlist',this)"><span>â­</span><span>WATCHLIST</span></button>
    <button class="bnav-item" onclick="bnav('compare',this)"><span>âš–ï¸</span><span>COMPARE</span></button>
    <button class="bnav-item" onclick="bnav('alerts',this)"><span>ğŸ””</span><span>ALERTS</span></button>
  </div>
</div>
<div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div>
<div class="app">
  <nav>
    <div class="logo"><div class="logo-dot">âš¡</div>QuantEdge</div>
    <div class="nav-right">
      <div class="nav-badge">v2.0 LIVE</div>
      <div class="nav-badge" style="color:var(--accent);border-color:rgba(79,255,176,0.3);" id="liveStatusBadge">â— LIVE DATA</div>
      <div class="nav-date" id="navDate">â€”</div>
    </div>
  </nav>
  <div class="hero">
    <h1>Intelligent<br><em>Quant Ratings</em></h1>
    <p>Live Î±Î»Î³Î¿ÏÎ¹Î¸Î¼Î¹ÎºÎ® Î±Î½Î¬Î»Ï…ÏƒÎ· Î¼ÎµÏ„Î¿Ï‡ÏÎ½ Î²Î±ÏƒÎ¹ÏƒÎ¼Î­Î½Î· ÏƒÎµ real-time FMP data. ÎŒÎ»ÎµÏ‚ Î¿Î¹ S&amp;P 500 Î¼ÎµÏ„Î¿Ï‡Î­Ï‚ â€” Instant grades, factor breakdown, analyst consensus.</p>
  </div>
  <div class="search-wrap">
    <div class="search-box">
      <span>ğŸ”</span>
      <input type="text" id="searchInput" placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ ticker symbol (Ï€.Ï‡. AAPL, MSFT, NVDA...)" maxlength="8">
    </div>
    <button class="btn-analyze" onclick="analyzeStock()">ANALYZE â†’</button>
  </div>
  <!-- Dynamic Screener -->
  <div class="screener-wrap">
    <div class="screener-tabs">
      <span class="screener-label">BROWSE:</span>
      <div class="screener-tab active" id="tab-featured"  onclick="switchTab('featured',this)">â­ FEATURED</div>
      <div class="screener-tab tab-actives"  id="tab-actives"  onclick="switchTab('actives',this)">ğŸ”¥ MOST ACTIVE</div>
      <div class="screener-tab tab-gainers"  id="tab-gainers"  onclick="switchTab('gainers',this)">ğŸ“ˆ GAINERS</div>
      <div class="screener-tab tab-losers"   id="tab-losers"   onclick="switchTab('losers',this)">ğŸ“‰ LOSERS</div>
      <div class="screener-tab tab-sp500"    id="tab-sp500"    onclick="switchTab('sp500',this)">ğŸ› S&amp;P 500</div>
    </div>
    <div id="sp500SearchWrap" style="display:none">
      <input type="text" class="sp500-search" id="sp500SearchInput" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ticker Î® ÎµÏ„Î±Î¹ÏÎµÎ¯Î±Ï‚ ÏƒÏ„Î¿ S&P 500..." oninput="filterSP500()">
    </div>
    <div class="screener-chips" id="screenerChips">
      <div class="screener-loading">âš¡ Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
    </div>
  </div>
  <div class="method-note">
    <strong>Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î¿ Î±Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿Ï‚ v2.0:</strong> ÎšÎ¬Î¸Îµ Î¼ÎµÏ„Î¿Ï‡Î® Î±Î¾Î¹Î¿Î»Î¿Î³ÎµÎ¯Ï„Î±Î¹ Î¼Îµ <strong>100% live Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¼Î­ÏƒÏ‰ FMP API</strong> ÏƒÎµ 5 ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚: Valuation (PE/PS/EV-EBITDA), Growth (revenue/EPS YoY), Profitability (margins/ROE/ROIC), Momentum (52W range/price action) ÎºÎ±Î¹ <strong>Revisions (analyst buy%/price target/beat rate)</strong>. Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ <strong style="color:var(--accent)">ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ S&amp;P 500 Î¼ÎµÏ„Î¿Ï‡Î­Ï‚ + Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ US ticker.</strong>
  </div>
  <div id="scoreArea" style="display:none;">
    <div class="score-header" id="scoreHeader">
      <div class="ticker-info">
        <div class="ticker" id="hTicker">â€”</div>
        <div class="name" id="hName">â€”</div>
        <div class="sector" id="hSector">â€”</div>
        <div id="hRec" class="rec-badge" style="margin-top:10px;">â€”</div>
      </div>
      <div class="overall-score">
        <div class="score-circle" id="scoreCircle" style="--pct:0%">
          <span class="score-num" id="scoreNum">â€”</span>
          <span class="score-max">/5.0</span>
        </div>
        <div class="score-label">QUANT SCORE</div>
      </div>
      <div class="price-info">
        <div class="price" id="hPrice">â€”</div>
        <div class="change" id="hChange">â€”</div>
        <div class="mkt-cap" id="hMktCap">â€”</div>
        <div class="live-badge" id="hLiveBadge" style="display:none"><span class="live-dot"></span>LIVE</div>
      </div>
    </div>
    <div class="factor-grid" id="factorGrid"></div>
    <div class="detail-panel" id="detailPanel">
      <div class="detail-header">
        <h3 id="detailTitle">â€”</h3>
        <button class="close-btn" onclick="closeDetail()">âœ• ÎºÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
      <table class="metrics-table" id="detailTable"></table>
    </div>
    <div class="charts-row">
      <div class="chart-panel"><h4>Factor Radar</h4><canvas id="radarCanvas" width="360" height="300"></canvas></div>
      <div class="chart-panel"><h4>Sector Percentile Ranking</h4><canvas id="barCanvas" width="360" height="300"></canvas></div>
    </div>
    <div class="compare-section" id="compareSection"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FMP_KEY = '5UlKrqpXlOKU5tLBhzWw6nwNbA7sLNfD';
const BASE    = 'https://financialmodelingprep.com/api/v3';

// Cache Î³Î¹Î± Î±Î½Î±Î»ÏÏƒÎµÎ¹Ï‚ (10 Î»ÎµÏ€Ï„Î¬ TTL)
const analysisCache = {};
const ANALYSIS_TTL  = 10 * 60 * 1000;

// Cache Î³Î¹Î± screener tabs (5 Î»ÎµÏ€Ï„Î¬ TTL)
const tabCache = {};
const TAB_TTL  = 5 * 60 * 1000;

// S&P 500 tickers (full list, Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ Î¼ÏŒÎ»Î¹Ï‚ Ï†Î¿ÏÏ„Ï‰Î¸ÎµÎ¯)
let sp500List = [];

let currentStock  = null;
let currentTab    = 'featured';
let activeChipTicker = 'NVDA';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateNavDate(){
  const now=new Date();
  const days=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  const months=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  document.getElementById('navDate').textContent=
    `${days[now.getDay()]} ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
}
updateNavDate();
setInterval(updateNavDate, 60000);

async function fetchWithTimeout(url, ms=8000){
  const ctrl=new AbortController();
  const tid=setTimeout(()=>ctrl.abort(), ms);
  try{
    const res=await fetch(url,{signal:ctrl.signal});
    clearTimeout(tid);
    return res;
  }catch(e){clearTimeout(tid);throw e;}
}

function fmt(n, decimals=2){
  if(n===null||n===undefined||isNaN(n)) return 'N/A';
  return parseFloat(n.toFixed(decimals));
}

function fmtPct(n, decimals=1){
  if(n===null||n===undefined||isNaN(n)) return 'N/A';
  const v=parseFloat((n*100).toFixed(decimals));
  return v+'%';
}

function formatMktCap(n){
  if(!n||isNaN(n)) return 'â€”';
  if(n>=1e12) return '$'+(n/1e12).toFixed(2)+'T';
  if(n>=1e9)  return '$'+(n/1e9).toFixed(1)+'B';
  if(n>=1e6)  return '$'+(n/1e6).toFixed(0)+'M';
  return '$'+n;
}

function numToGrade(n){
  if(n>=9)   return 'A+';
  if(n>=7.5) return 'A';
  if(n>=6)   return 'B';
  if(n>=4.5) return 'C';
  if(n>=3)   return 'D';
  return 'F';
}

function gradeColor(g){
  const m={'A+':'gAp','A':'gA','B':'gB','B+':'gA','C':'gC','D':'gD','F':'gF'};
  return m[g]||'gC';
}

function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

function barColor(pct){
  if(pct>=75) return 'var(--grade-a)';
  if(pct>=50) return 'var(--grade-c)';
  if(pct>=25) return 'var(--grade-d)';
  return 'var(--grade-f)';
}

function updateLiveBadge(source){
  const el=document.getElementById('liveStatusBadge');
  if(!el) return;
  if(source==='live'){
    el.textContent='â— LIVE';
    el.style.color='var(--accent)';
    el.style.borderColor='rgba(79,255,176,0.3)';
  } else if(source==='cache'){
    el.textContent='ğŸ“¦ CACHED';
    el.style.color='var(--warn)';
    el.style.borderColor='rgba(255,181,71,0.3)';
  } else {
    el.textContent='âš  OFFLINE';
    el.style.color='var(--danger)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORING ENGINE â€” live data â†’ grades
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scoreValuation(pe, ps, evEbitda, pb){
  let s=5;
  // PE
  if(pe>0&&pe<12)      s+=3;
  else if(pe>0&&pe<18) s+=2;
  else if(pe>0&&pe<28) s+=1;
  else if(pe>40)       s-=1;
  else if(pe>60)       s-=2;
  else if(pe>100)      s-=3;
  // PS
  if(ps>0&&ps<2)       s+=2;
  else if(ps>0&&ps<6)  s+=1;
  else if(ps>15)       s-=1;
  else if(ps>30)       s-=2;
  // EV/EBITDA
  if(evEbitda>0&&evEbitda<10) s+=1;
  else if(evEbitda>30)        s-=1;
  else if(evEbitda>50)        s-=2;
  // PB
  if(pb>0&&pb<2)       s+=1;
  else if(pb>8)        s-=1;
  return clamp(s,1,10);
}

function scoreGrowth(revGrowth, epsGrowth){
  let s=5;
  // Revenue growth
  if(revGrowth>80)      s+=4;
  else if(revGrowth>40) s+=3;
  else if(revGrowth>20) s+=2;
  else if(revGrowth>10) s+=1;
  else if(revGrowth<0)  s-=2;
  else if(revGrowth<5)  s-=1;
  // EPS growth
  if(epsGrowth>50)      s+=2;
  else if(epsGrowth>20) s+=1;
  else if(epsGrowth<-20) s-=2;
  else if(epsGrowth<0)  s-=1;
  return clamp(s,1,10);
}

function scoreProfitability(grossM, netM, roe, roic){
  let s=5;
  // Gross margin
  if(grossM>70)      s+=3;
  else if(grossM>50) s+=2;
  else if(grossM>35) s+=1;
  else if(grossM<20) s-=1;
  else if(grossM<10) s-=2;
  // Net margin
  if(netM>25)       s+=2;
  else if(netM>12)  s+=1;
  else if(netM<0)   s-=2;
  else if(netM<5)   s-=1;
  // ROE
  if(roe>30)        s+=2;
  else if(roe>15)   s+=1;
  else if(roe<0)    s-=2;
  // ROIC
  if(roic>20)       s+=1;
  else if(roic<0)   s-=1;
  return clamp(s,1,10);
}

function scoreMomentum(pos52pct, changePct, beta){
  let s=5;
  // 52W position (0-100)
  if(pos52pct>85)      s+=3;
  else if(pos52pct>70) s+=2;
  else if(pos52pct>55) s+=1;
  else if(pos52pct<20) s-=2;
  else if(pos52pct<35) s-=1;
  // Today's change
  if(changePct>3)       s+=1;
  else if(changePct<-3) s-=1;
  // Beta moderate is better for scoring
  if(beta>3)            s-=1;
  return clamp(s,1,10);
}

function scoreRevisions(buyPct, upside, beatRate, epsRevPct){
  let s=5;
  // Analyst buy %
  if(buyPct>=90)        s+=3;
  else if(buyPct>=75)   s+=2;
  else if(buyPct>=60)   s+=1;
  else if(buyPct<40)    s-=1;
  else if(buyPct<30)    s-=2;
  // Price target upside
  if(upside>40)         s+=2;
  else if(upside>20)    s+=1;
  else if(upside<0)     s-=2;
  else if(upside<5)     s-=1;
  // Beat rate (0-1)
  if(beatRate>=0.9)     s+=1;
  else if(beatRate<0.4) s-=1;
  // EPS revision trend
  if(epsRevPct>5)       s+=1;
  else if(epsRevPct<-5) s-=1;
  return clamp(s,1,10);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE DATA FETCHER â€” ALL indicators via FMP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchFullFMPData(ticker){
  // Check cache
  if(analysisCache[ticker]){
    const c=analysisCache[ticker];
    if(Date.now()-c.ts < ANALYSIS_TTL){
      updateLiveBadge('cache');
      return c.data;
    }
  }

  try{
    // Fire all requests in parallel
    const [quoteRes, profileRes, ratiosTTMRes, growthRes, analystRes, targetRes, surprisesRes, estimatesRes] = await Promise.all([
      fetchWithTimeout(`${BASE}/quote/${ticker}?apikey=${FMP_KEY}`, 8000),
      fetchWithTimeout(`${BASE}/profile/${ticker}?apikey=${FMP_KEY}`, 8000),
      fetchWithTimeout(`${BASE}/ratios-ttm/${ticker}?apikey=${FMP_KEY}`, 8000),
      fetchWithTimeout(`${BASE}/financial-growth/${ticker}?limit=2&apikey=${FMP_KEY}`, 8000),
      fetchWithTimeout(`${BASE}/analyst-stock-recommendations/${ticker}?limit=4&apikey=${FMP_KEY}`, 8000),
      fetchWithTimeout(`${BASE}/price-target-consensus/${ticker}?apikey=${FMP_KEY}`, 8000),
      fetchWithTimeout(`${BASE}/earnings-surprises/${ticker}?apikey=${FMP_KEY}`, 8000),
      fetchWithTimeout(`${BASE}/analyst-estimates/${ticker}?limit=2&apikey=${FMP_KEY}`, 8000),
    ]);

    const quote    = (await quoteRes.json())[0];
    const profile  = (await profileRes.json())[0];
    const ratios   = (await ratiosTTMRes.json())[0];
    const growArr  = await growthRes.json();
    const analystArr = await analystRes.json();
    const targetRaw  = await targetRes.json();
    const surprisesArr = await surprisesRes.json();
    const estimatesArr = await estimatesRes.json();

    if(!quote||!profile) return null;

    // â”€â”€ Basic info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const price     = quote.price         || 0;
    const changePct = quote.changesPercentage || 0;
    const mktCap    = quote.marketCap     || 0;
    const name      = profile.companyName || ticker;
    const sector    = profile.sector      || profile.industry || 'N/A';
    const industry  = profile.industry    || sector;
    const high52    = quote.yearHigh      || price*1.2;
    const low52     = quote.yearLow       || price*0.8;
    const beta      = parseFloat(profile.beta)||1;
    const vol       = quote.volume        || 0;
    const avgVol    = quote.avgVolume     || 0;
    const divYield  = (ratios?.dividendYielTTM||0)*100;

    // â”€â”€ Valuation metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const pe        = parseFloat(ratios?.peRatioTTM        || quote.pe      || 0) || 0;
    const fwdPE     = pe>0 ? pe*0.85 : 0; // approximate
    const ps        = parseFloat(ratios?.priceToSalesRatioTTM    || 0) || 0;
    const pb        = parseFloat(ratios?.priceToBookRatioTTM     || 0) || 0;
    const evEbitda  = parseFloat(ratios?.enterpriseValueMultipleTTM || 0) || 0;
    const debtEq    = parseFloat(ratios?.debtEquityRatioTTM || 0) || 0;
    const currentR  = parseFloat(ratios?.currentRatioTTM   || 0) || 0;

    // â”€â”€ Profitability metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const grossM    = parseFloat(ratios?.grossProfitMarginTTM  || 0)*100;
    const opM       = parseFloat(ratios?.operatingProfitMarginTTM || 0)*100;
    const netM      = parseFloat(ratios?.netProfitMarginTTM    || 0)*100;
    const roe       = parseFloat(ratios?.returnOnEquityTTM     || 0)*100;
    const roa       = parseFloat(ratios?.returnOnAssetsTTM     || 0)*100;
    const roic      = parseFloat(ratios?.returnOnCapitalEmployedTTM || 0)*100;
    const fcfM      = parseFloat(ratios?.freeCashFlowPerShareTTM || 0);

    // â”€â”€ Growth metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const growth    = Array.isArray(growArr)&&growArr[0] ? growArr[0] : {};
    const revGrowth = parseFloat(growth.revenueGrowth||0)*100;
    const epsGrowth = parseFloat(growth.epsgrowth    ||0)*100;
    const grossGrowth = parseFloat(growth.grossProfitGrowth||0)*100;
    const fcfGrowth   = parseFloat(growth.freeCashFlowGrowth||0)*100;
    // YoY comparison (if 2 periods)
    const growth2   = Array.isArray(growArr)&&growArr[1] ? growArr[1] : {};
    const revGrowthPY = parseFloat(growth2.revenueGrowth||0)*100;
    const growthAccel = revGrowth - revGrowthPY; // positive = accelerating

    // â”€â”€ Analyst Revisions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Aggregate last 4 periods of recommendations
    let totalBuy=0, totalHold=0, totalSell=0;
    if(Array.isArray(analystArr)){
      analystArr.slice(0,4).forEach(a=>{
        totalBuy  += (a.analystRatingsbuy||0) + (a.analystRatingsStrongBuy||0);
        totalHold += (a.analystRatingsHold||0);
        totalSell += (a.analystRatingsSell||0) + (a.analystRatingsStrongSell||0);
      });
    }
    const totalAnalysts = totalBuy+totalHold+totalSell;
    const buyPct = totalAnalysts>0 ? (totalBuy/totalAnalysts)*100 : 50;

    // Price target
    const targetData  = Array.isArray(targetRaw)&&targetRaw[0] ? targetRaw[0] : (targetRaw||{});
    const targetPrice = parseFloat(targetData.targetConsensus||targetData.priceTarget||0)||0;
    const targetHigh  = parseFloat(targetData.targetHigh||targetPrice*1.2)||0;
    const targetLow   = parseFloat(targetData.targetLow||targetPrice*0.8)||0;
    const upside      = targetPrice>0 ? ((targetPrice-price)/price)*100 : 0;

    // Earnings surprises â€” beat rate last 8Q
    let beats=0, total_surp=0;
    if(Array.isArray(surprisesArr)){
      surprisesArr.slice(0,8).forEach(s=>{
        const actual=parseFloat(s.actualEarningResult||0);
        const est   =parseFloat(s.estimatedEarning  ||0);
        total_surp++;
        if(actual>=est) beats++;
      });
    }
    const beatRate   = total_surp>0 ? beats/total_surp : 0.5;
    const beatRatePct = Math.round(beatRate*100);

    // EPS estimate revision trend (current vs previous year estimate change)
    let epsRevPct = 0;
    if(Array.isArray(estimatesArr)&&estimatesArr.length>=2){
      const cur  = parseFloat(estimatesArr[0]?.estimatedEpsAvg||0);
      const prev = parseFloat(estimatesArr[1]?.estimatedEpsAvg||0);
      if(prev!==0) epsRevPct = ((cur-prev)/Math.abs(prev))*100;
    }

    // â”€â”€ 52W momentum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const range52     = high52-low52;
    const pos52pct    = range52>0 ? clamp(((price-low52)/range52)*100,0,100) : 50;
    const fromHigh    = ((price/high52)-1)*100;
    const fromLow     = ((price/low52)-1)*100;
    const volRatio    = avgVol>0 ? vol/avgVol : 1;

    // â”€â”€ SCORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const valScore   = scoreValuation(pe, ps, evEbitda, pb);
    const growScore  = scoreGrowth(revGrowth, epsGrowth);
    const profScore  = scoreProfitability(grossM, netM, roe, roic);
    const momScore   = scoreMomentum(pos52pct, changePct, beta);
    const revScore   = scoreRevisions(buyPct, upside, beatRate, epsRevPct);

    // Weighted overall (1-5 scale)
    const rawOverall = (valScore*0.20)+(growScore*0.25)+(profScore*0.25)+(momScore*0.15)+(revScore*0.15);
    const overallScore = parseFloat(clamp(rawOverall/2, 1, 5).toFixed(1));

    const rec = overallScore>=4.2?'STRONG BUY':overallScore>=3.5?'BUY':overallScore>=2.5?'HOLD':'SELL';

    // â”€â”€ BUILD factors object â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const valPct  = Math.round(valScore*10);
    const growPct = Math.round(growScore*10);
    const profPct = Math.round(profScore*10);
    const momPct  = Math.round(momScore*10);
    const revPct  = Math.round(revScore*10);

    const data = {
      name, sector, industry,
      price:   '$'+price.toFixed(2),
      rawPrice: price,
      change:  parseFloat(changePct.toFixed(2)),
      mktCap:  formatMktCap(mktCap),
      rawMktCap: mktCap,
      overallScore,
      recommendation: rec,
      liveData: true,
      beta,
      exchange: profile.exchangeShortName||'US',
      factors:{
        valuation:{
          grade: numToGrade(valScore),
          score: parseFloat(valScore.toFixed(1)),
          pct:   valPct,
          trend: pe>0&&pe<20?'â†‘ attractive':pe<35?'â†’ fair':'â†“ expensive',
          desc:  'Î‘Ï€Î¿Ï„Î¯Î¼Î·ÏƒÎ· vs Benchmarks',
          metrics:[
            ['P/E (TTM)',    pe>0?pe.toFixed(1)+'Ã—':'N/A',       pe<15?'Cheap':pe<30?'Fair':pe<50?'Expensive':'Very Rich',  pe>0?clamp(Math.round(100-pe*0.8),5,95):null],
            ['Forward P/E',  fwdPE>0?fwdPE.toFixed(1)+'Ã—':'N/A','Estimated fwd multiple',                                   fwdPE>0?clamp(Math.round(100-fwdPE*0.8),5,95):null],
            ['P/S Ratio',    ps>0?ps.toFixed(1)+'Ã—':'N/A',        ps<3?'Good value':ps<10?'Fair':'Rich',                    ps>0?clamp(Math.round(80-ps*2),5,95):null],
            ['EV/EBITDA',    evEbitda>0?evEbitda.toFixed(1)+'Ã—':'N/A','Enterprise multiple',                                 evEbitda>0?clamp(Math.round(90-evEbitda),5,95):null],
            ['P/B Ratio',    pb>0?pb.toFixed(1)+'Ã—':'N/A',        pb<2?'Below book':pb<5?'Fair':'Premium',                  pb>0?clamp(Math.round(80-pb*5),5,95):null],
            ['Debt/Equity',  debtEq.toFixed(2)+'Ã—',               debtEq<0.5?'Low leverage':debtEq<1.5?'Moderate':'High',  clamp(Math.round(80-debtEq*20),5,95)],
            ['Div Yield',    divYield>0?divYield.toFixed(2)+'%':'None','Income component',                                   divYield>0?clamp(Math.round(divYield*15),5,85):20],
          ]
        },
        growth:{
          grade: numToGrade(growScore),
          score: parseFloat(growScore.toFixed(1)),
          pct:   growPct,
          trend: revGrowth>30?'â†‘â†‘ accelerating':revGrowth>10?'â†‘ solid':revGrowth>0?'â†’ modest':'â†“ declining',
          desc:  'Î‘Î½Î¬Ï€Ï„Ï…Î¾Î· Î•ÏƒÏŒÎ´Ï‰Î½ & EPS',
          metrics:[
            ['Revenue Growth YoY', revGrowth!==0?fmt(revGrowth,1)+'%':'N/A',       revGrowth>30?'Strong':revGrowth>10?'Moderate':revGrowth>0?'Weak':'Declining',      clamp(Math.round(50+revGrowth*0.8),5,95)],
            ['EPS Growth YoY',     epsGrowth!==0?fmt(epsGrowth,1)+'%':'N/A',       epsGrowth>20?'Strong':'Moderate',                                                   clamp(Math.round(50+epsGrowth*0.5),5,95)],
            ['Gross Profit Growth',grossGrowth!==0?fmt(grossGrowth,1)+'%':'N/A',   grossGrowth>revGrowth?'Expanding margin':'Inline',                                  clamp(Math.round(50+grossGrowth*0.6),5,95)],
            ['FCF Growth',         fcfGrowth!==0?fmt(fcfGrowth,1)+'%':'N/A',       'Free cash flow expansion',                                                         clamp(Math.round(50+fcfGrowth*0.4),5,95)],
            ['Growth Acceleration',fmt(growthAccel,1)+'%',                          growthAccel>0?'â†‘ Accelerating':'â†“ Decelerating',                                   clamp(Math.round(50+growthAccel*2),5,95)],
            ['52W High',           '$'+high52.toFixed(2),                           fmt(fromHigh,1)+'% from high',                                                     Math.round(pos52pct)],
            ['52W Low',            '$'+low52.toFixed(2),                            '+'+fmt(fromLow,1)+'% from low',                                                   Math.round(pos52pct)],
          ]
        },
        profitability:{
          grade: numToGrade(profScore),
          score: parseFloat(profScore.toFixed(1)),
          pct:   profPct,
          trend: netM>20?'â†‘â†‘ exceptional':netM>8?'â†‘ solid':netM>0?'â†’ moderate':'â†“ unprofitable',
          desc:  'ÎšÎµÏÎ´Î¿Ï†Î¿ÏÎ¯Î± & Î‘Ï€Î¿Î´ÏŒÏƒÎµÎ¹Ï‚',
          metrics:[
            ['Gross Margin',   grossM>0?fmt(grossM,1)+'%':'N/A', grossM>60?'Excellent':grossM>35?'Good':'Low',   clamp(Math.round(grossM),5,95)],
            ['Operating Margin',opM>0?fmt(opM,1)+'%':'N/A',      opM>20?'Strong':opM>8?'Good':'Thin',            clamp(Math.round(opM*2),5,95)],
            ['Net Margin',     netM!==0?fmt(netM,1)+'%':'N/A',   netM>20?'Excellent':netM>5?'Decent':'Low',      clamp(Math.round(Math.max(netM*2.5,5)),5,95)],
            ['ROE',            roe!==0?fmt(roe,1)+'%':'N/A',     roe>20?'Excellent':roe>8?'Good':'Low',          clamp(Math.round(roe*2),5,95)],
            ['ROA',            roa!==0?fmt(roa,1)+'%':'N/A',     roa>8?'Strong':roa>3?'Decent':'Low',            clamp(Math.round(roa*4),5,95)],
            ['ROIC',           roic!==0?fmt(roic,1)+'%':'N/A',   roic>15?'Best-in-class':roic>5?'Good':'Low',   clamp(Math.round(roic*2.5),5,95)],
            ['Current Ratio',  currentR>0?fmt(currentR,2)+'Ã—':'N/A','Liquidity',                                  clamp(Math.round(currentR*25),5,90)],
          ]
        },
        momentum:{
          grade: numToGrade(momScore),
          score: parseFloat(momScore.toFixed(1)),
          pct:   momPct,
          trend: pos52pct>80?'â†‘â†‘ near highs':pos52pct>50?'â†‘ mid range':'â†“ below midpoint',
          desc:  'Price Momentum & Î¤ÎµÏ‡Î½Î¹ÎºÎ®',
          metrics:[
            ['Î¤Î¹Î¼Î®',              '$'+price.toFixed(2),     'Live â€” FMP real-time',                               50],
            ['ÎœÎµÏ„Î±Î²Î¿Î»Î® ÏƒÎ®Î¼ÎµÏÎ±',  fmt(changePct,2)+'%',     changePct>=0?'Positive':'Negative',                   changePct>=0?65:35],
            ['52W Î¸Î­ÏƒÎ·',          Math.round(pos52pct)+'%', pos52pct>70?'Near highs':pos52pct>30?'Mid range':'Near lows', Math.round(pos52pct)],
            ['vs 52W High',       fmt(fromHigh,1)+'%',      'Î‘Ï€ÏŒÏƒÏ„Î±ÏƒÎ· Î±Ï€ÏŒ Ï…ÏˆÎ·Î»ÏŒ',                                Math.round(pos52pct)],
            ['vs 52W Low',        '+'+fmt(fromLow,1)+'%',   'Î†Î½Î¿Î´Î¿Ï‚ Î±Ï€ÏŒ Ï‡Î±Î¼Î·Î»ÏŒ',                                 Math.round(pos52pct)],
            ['Volume vs Avg',     fmt(volRatio,2)+'Ã—',      volRatio>1.5?'High volume':volRatio>0.7?'Normal':'Low volume', clamp(Math.round(volRatio*40),5,95)],
            ['Beta',              fmt(beta,2),               beta>1.5?'High volatility':beta<0.8?'Low volatility':'Moderate', clamp(Math.round(100-beta*15),5,85)],
          ]
        },
        revisions:{
          grade: numToGrade(revScore),
          score: parseFloat(revScore.toFixed(1)),
          pct:   revPct,
          trend: buyPct>75?'â†‘â†‘ very bullish':buyPct>55?'â†‘ positive':buyPct>40?'â†’ mixed':'â†“ negative',
          desc:  'Analyst Consensus & EPS Revisions',
          metrics:[
            ['Buy Ratings',     totalAnalysts>0?Math.round(totalBuy)+'/'+totalAnalysts+' ('+Math.round(buyPct)+'%)':'N/A', buyPct>75?'Bullish':buyPct>50?'Moderate':'Mixed', clamp(Math.round(buyPct),5,95)],
            ['Hold Ratings',    totalAnalysts>0?Math.round(totalHold)+'':'N/A',          'Neutral analysts',                clamp(Math.round(100-buyPct),5,95)],
            ['Price Target',    targetPrice>0?'$'+targetPrice.toFixed(2):'N/A',          'Analyst consensus target',        clamp(Math.round(50+upside),5,95)],
            ['Target Upside',   fmt(upside,1)+'%',                                       upside>20?'Significant':upside>0?'Modest':'Downside', clamp(Math.round(50+upside),5,95)],
            ['Target High',     targetHigh>0?'$'+targetHigh.toFixed(2):'N/A',            'ÎœÎ­Î³Î¹ÏƒÏ„Î¿Ï‚ ÏƒÏ„ÏŒÏ‡Î¿Ï‚',                clamp(Math.round(50+((targetHigh-price)/price)*100),5,95)],
            ['Beat Rate (8Q)',   total_surp>0?beats+'/'+total_surp+' ('+beatRatePct+'%)':'N/A','EPS beats last 8 quarters',   clamp(beatRatePct,5,95)],
            ['EPS Rev Trend',   fmt(epsRevPct,1)+'%',                                    epsRevPct>0?'â†‘ Upgrades':'â†“ Downgrades', clamp(Math.round(50+epsRevPct),5,95)],
          ]
        }
      },
      compare:{
        ticker: sector.includes('Tech')||sector.includes('Semi')?'QQQ':'SPY',
        grade:'B', score:3.5
      },
      _ts: Date.now()
    };

    // Cache it
    analysisCache[ticker]={data, ts:Date.now()};
    updateLiveBadge('live');
    return data;

  } catch(e){
    console.error('[QE] fetchFullFMPData error:', ticker, e.message);
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREENER â€” Featured & Dynamic Tabs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FEATURED_TICKERS = [
  'NVDA','META','AAPL','MSFT','GOOGL','AMZN','TSLA',
  'AVGO','AMD','MRVL','CRDO','NFLX','CRM','NOW',
  'PLTR','UBER','V','JPM','LLY','COIN','INTC','SHOP',
  'ORCL','ADBE','QCOM','ARM','ANET','SMCI','DELL','MU'
];

// Live price cache for featured chips (lightweight)
const priceCache = {};
const PRICE_TTL = 10*60*1000;

async function fetchBatchQuotes(tickers){
  try{
    const joined=tickers.join(',');
    const res=await fetchWithTimeout(`${BASE}/quote/${joined}?apikey=${FMP_KEY}`,10000);
    if(!res.ok) return;
    const arr=await res.json();
    if(!Array.isArray(arr)) return;
    arr.forEach(q=>{
      if(q?.symbol&&q?.price){
        priceCache[q.symbol]={price:q.price, change:parseFloat((q.changesPercentage||0).toFixed(2)), ts:Date.now()};
      }
    });
  } catch(e){console.warn('[QE] Batch quote fail:',e.message);}
}

function renderFeaturedChips(){
  const container=document.getElementById('screenerChips');
  container.innerHTML=FEATURED_TICKERS.map(t=>{
    const p=priceCache[t];
    const chStr=p?`<span class="chip-change ${p.change>=0?'up':'down'}">${p.change>=0?'+':''}${p.change?.toFixed(2)}%</span>`:'';
    return `<div class="screener-chip ${t===activeChipTicker?'active':''}" onclick="selectPreset('${t}',this)" data-ticker="${t}">${t}${chStr}</div>`;
  }).join('');
}

function renderDynamicChips(items){
  const container=document.getElementById('screenerChips');
  if(!items||items.length===0){container.innerHTML='<div class="screener-loading">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</div>';return;}
  container.innerHTML=items.map(item=>{
    const rawCh=item.changesPercentage??item.changePercent??item.change??null;
    const ch=rawCh!==null?parseFloat(rawCh):null;
    const chStr=(ch!==null&&!isNaN(ch))?`<span class="chip-change ${ch>=0?'up':'down'}">${ch>=0?'+':''}${ch.toFixed(2)}%</span>`:'';
    const t=item.symbol||item.ticker||'';
    if(!t) return '';
    return `<div class="screener-chip ${t===activeChipTicker?'active':''}" onclick="selectPreset('${t}',this)" data-ticker="${t}">${t}${chStr}</div>`;
  }).join('');
}

// SP500 full list rendering with search
function renderSP500Chips(list, query=''){
  const container=document.getElementById('screenerChips');
  const filtered=query
    ? list.filter(s=>(s.symbol||'').includes(query.toUpperCase())||(s.name||'').toUpperCase().includes(query.toUpperCase()))
    : list;
  if(filtered.length===0){container.innerHTML='<div class="screener-loading">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ticker</div>';return;}
  container.innerHTML=filtered.map(item=>{
    const t=item.symbol||'';
    if(!t) return '';
    const shortName=(item.name||'').split(' ').slice(0,2).join(' ');
    return `<div class="screener-chip ${t===activeChipTicker?'active':''}" onclick="selectPreset('${t}',this)" data-ticker="${t}" title="${item.name||t}">${t} <span style="font-size:9px;opacity:0.6;max-width:80px;overflow:hidden;text-overflow:ellipsis">${shortName}</span></div>`;
  }).join('');
}

function filterSP500(){
  const q=document.getElementById('sp500SearchInput').value.trim();
  renderSP500Chips(sp500List, q);
}

async function loadTab(tab){
  const container=document.getElementById('screenerChips');
  const sp500Wrap=document.getElementById('sp500SearchWrap');

  // Show/hide SP500 search
  sp500Wrap.style.display=(tab==='sp500')?'block':'none';

  if(tab==='featured'){
    renderFeaturedChips();
    // Load prices in background if not fresh
    const needsRefresh=FEATURED_TICKERS.some(t=>!priceCache[t]||(Date.now()-priceCache[t].ts>PRICE_TTL));
    if(needsRefresh) fetchBatchQuotes(FEATURED_TICKERS).then(renderFeaturedChips);
    return;
  }

  // Cache check
  if(tabCache[tab]&&(Date.now()-tabCache[tab].ts<TAB_TTL)){
    if(tab==='sp500') renderSP500Chips(tabCache[tab].data);
    else renderDynamicChips(tabCache[tab].data);
    return;
  }

  container.innerHTML='<div class="screener-loading">âš¡ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>';

  try{
    if(tab==='sp500'){
      const res=await fetchWithTimeout(`${BASE}/sp500_constituent?apikey=${FMP_KEY}`,12000);
      const json=await res.json();
      if(!Array.isArray(json)||json.length===0) throw new Error('SP500 empty');
      // Sort alphabetically
      const sorted=json.slice().sort((a,b)=>(a.symbol||'').localeCompare(b.symbol||''));
      sp500List=sorted;
      tabCache['sp500']={data:sorted, ts:Date.now()};
      renderSP500Chips(sorted);
      // Also preload a batch of prices for the first 50
      fetchBatchQuotes(sorted.slice(0,50).map(s=>s.symbol));

    } else {
      const endpointMap={actives:'stock_market/actives',gainers:'stock_market/gainers',losers:'stock_market/losers'};
      const res=await fetchWithTimeout(`${BASE}/${endpointMap[tab]}?apikey=${FMP_KEY}`,10000);
      const json=await res.json();
      const arr=Array.isArray(json)?json:[];
      if(arr.length===0) throw new Error(`${tab} empty`);
      tabCache[tab]={data:arr, ts:Date.now()};
      renderDynamicChips(arr);
    }
  } catch(e){
    console.error('[QE] Tab error:',e);
    container.innerHTML=`<div class="screener-loading" style="color:var(--danger)">âš  Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î±: ${e.message.slice(0,80)}</div>`;
  }
}

async function switchTab(tab, el){
  document.querySelectorAll('.screener-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  currentTab=tab;
  await loadTab(tab);
}

function selectPreset(ticker, el){
  activeChipTicker=ticker;
  document.querySelectorAll('.screener-chip').forEach(c=>c.classList.remove('active'));
  if(el&&el.classList) el.classList.add('active');
  document.getElementById('searchInput').value=ticker;
  analyzeStock(ticker);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYZE STOCK â€” main flow
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyzeStock(forceTicker){
  const ticker=(forceTicker||document.getElementById('searchInput').value.trim().toUpperCase());
  if(!ticker) return;

  const bar=document.getElementById('loadingBar');
  bar.style.width='15%';bar.style.opacity='1';

  document.getElementById('scoreArea').style.display='block';
  showLoadingState(ticker);

  bar.style.width='55%';
  const data=await fetchFullFMPData(ticker);
  bar.style.width='100%';
  setTimeout(()=>{bar.style.opacity='0';bar.style.width='0%'},400);

  if(!data){showNotFound(ticker);return;}

  currentStock={ticker, ...data};
  restoreScoreHeader();
  hideLoadingState();
  document.getElementById('scoreArea').scrollIntoView({behavior:'smooth',block:'start'});
  renderHeader(ticker, data);
  renderFactors(data);
  closeDetail();
  setTimeout(()=>{renderRadar(data);renderBars(data);},100);
  renderCompare(data);

  // Update chip prices after analysis (we got fresh price)
  if(data.rawPrice){
    priceCache[ticker]={price:data.rawPrice, change:data.change, ts:Date.now()};
    if(currentTab==='featured') renderFeaturedChips();
  }
}

// â”€â”€ Auto-refresh current stock every 15 min â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(async()=>{
  if(!document.hidden&&currentStock){
    // Invalidate cache for current stock to force re-fetch
    delete analysisCache[currentStock.ticker];
    await analyzeStock(currentStock.ticker);
  }
}, 15*60*1000);

document.addEventListener('visibilitychange',()=>{
  if(!document.hidden&&currentStock){
    const c=analysisCache[currentStock.ticker];
    if(!c||(Date.now()-c.ts>5*60*1000)){
      delete analysisCache[currentStock.ticker];
      analyzeStock(currentStock.ticker);
    }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function restoreScoreHeader(){
  if(!document.getElementById('hTicker')){
    document.getElementById('scoreHeader').innerHTML=`
      <div class="ticker-info">
        <div class="ticker" id="hTicker">â€”</div>
        <div class="name" id="hName">â€”</div>
        <div class="sector" id="hSector">â€”</div>
        <div id="hRec" class="rec-badge" style="margin-top:10px;">â€”</div>
      </div>
      <div class="overall-score">
        <div class="score-circle" id="scoreCircle" style="--pct:0%">
          <span class="score-num" id="scoreNum">â€”</span>
          <span class="score-max">/5.0</span>
        </div>
        <div class="score-label">QUANT SCORE</div>
      </div>
      <div class="price-info">
        <div class="price" id="hPrice">â€”</div>
        <div class="change" id="hChange">â€”</div>
        <div class="mkt-cap" id="hMktCap">â€”</div>
        <div class="live-badge" id="hLiveBadge" style="display:none"><span class="live-dot"></span>LIVE</div>
      </div>`;
  }
}

function showLoadingState(ticker){
  restoreScoreHeader();
  const h=document.getElementById('scoreHeader');
  h.style.position='relative';
  let ol=document.getElementById('loadingOverlay');
  if(!ol){ol=document.createElement('div');ol.id='loadingOverlay';h.appendChild(ol);}
  ol.style.cssText='position:absolute;inset:0;background:var(--surface);border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;z-index:10;';
  ol.innerHTML=`
    <div style="font-size:2rem;animation:float 1.5s ease-in-out infinite">âš¡</div>
    <div style="font-size:1.1rem;color:#fff">Î‘Î½Î¬Î»Ï…ÏƒÎ· <span style="color:var(--accent)">${ticker}</span>...</div>
    <div style="font-size:11px;color:var(--text-dim);letter-spacing:0.1em">LIVE â€” 8 FMP endpoints ÏƒÎµ parallel</div>
    <div style="width:200px;height:2px;background:var(--border);border-radius:1px;overflow:hidden;margin-top:4px">
      <div style="height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));animation:splashLoad 2.5s ease infinite"></div>
    </div>`;
  document.getElementById('factorGrid').innerHTML='';
}

function hideLoadingState(){
  const ol=document.getElementById('loadingOverlay');
  if(ol) ol.remove();
}

function showNotFound(ticker){
  restoreScoreHeader();
  hideLoadingState();
  document.getElementById('scoreArea').style.display='block';
  document.getElementById('scoreHeader').innerHTML=`
    <div style="grid-column:1/-1;text-align:center;padding:28px;">
      <div style="font-size:2rem;margin-bottom:12px;">ğŸ“¡</div>
      <div style="font-size:1.1rem;color:#fff;margin-bottom:8px;">"${ticker}" â€” Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</div>
      <div style="font-size:13px;color:var(--text-dim);margin-bottom:12px;line-height:1.6;">
        Î¤Î¿ ticker Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼Î·Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ„Î¿ US market, Î® Ï„Î¿ FMP API<br>
        Î­Ï‡ÎµÎ¹ Ï†Ï„Î¬ÏƒÎµÎ¹ Ï„Î¿ <strong style="color:var(--warn)">ÏŒÏÎ¹Î¿ Ï„Ï‰Î½ 250 requests/Î·Î¼Î­ÏÎ±</strong>. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î±ÏÏÎ¹Î¿.
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px;">
        ${['NVDA','META','AAPL','MSFT','GOOGL','AMZN','TSLA','AVGO','AMD','MRVL','NFLX','PLTR','LLY','V'].map(t=>`
          <span onclick="selectPreset('${t}',null)" style="font-family:'JetBrains Mono',monospace;font-size:11px;padding:5px 12px;border:1px solid var(--border2);border-radius:20px;color:var(--accent);cursor:pointer;background:var(--glow);letter-spacing:0.05em;">${t}</span>`).join('')}
      </div>
    </div>`;
  document.getElementById('factorGrid').innerHTML='';
}

function renderHeader(ticker, data){
  document.getElementById('hTicker').textContent=ticker;
  document.getElementById('hName').textContent=data.name;
  document.getElementById('hSector').textContent=`${data.sector}${data.exchange?' Â· '+data.exchange:''}`;

  document.getElementById('hPrice').textContent=data.price||'â€”';
  const chEl=document.getElementById('hChange');
  if(data.change!==null&&data.change!==undefined){
    const sign=data.change>=0?'+':'';
    chEl.textContent=`${sign}${data.change}% (ÏƒÎ®Î¼ÎµÏÎ±)`;
    chEl.className=`change ${data.change>=0?'up':'down'}`;
  } else {chEl.textContent='â€”';chEl.className='change';}

  document.getElementById('hMktCap').textContent=data.mktCap||'â€”';
  const liveEl=document.getElementById('hLiveBadge');
  if(liveEl) liveEl.style.display=data.liveData?'inline-flex':'none';

  document.getElementById('hRec').textContent=data.recommendation;
  const rm={'STRONG BUY':'rec-strong-buy','BUY':'rec-buy','HOLD':'rec-hold','SELL':'rec-sell'};
  document.getElementById('hRec').className=`rec-badge ${rm[data.recommendation]||'rec-hold'}`;
  document.getElementById('scoreNum').textContent=data.overallScore.toFixed(1);
  const pct=(data.overallScore/5)*100;
  document.getElementById('scoreCircle').style.setProperty('--pct',pct+'%');
}

function renderFactors(data){
  const grid=document.getElementById('factorGrid');
  const icons={valuation:'ğŸ’µ',growth:'ğŸ“ˆ',profitability:'âš™ï¸',momentum:'ğŸš€',revisions:'ğŸ“Š'};
  const names={valuation:'VALUATION',growth:'GROWTH',profitability:'PROFIT',momentum:'MOMENTUM',revisions:'REVISIONS'};
  grid.innerHTML='';
  Object.entries(data.factors).forEach(([key,f],i)=>{
    const card=document.createElement('div');
    card.className='factor-card';
    card.style.animationDelay=`${i*0.07}s`;
    card.onclick=()=>openDetail(key,data);
    card.innerHTML=`
      <div class="factor-icon">${icons[key]}</div>
      <div class="factor-name">${names[key]}</div>
      <div class="grade-badge ${gradeColor(f.grade)}">${f.grade}</div>
      <div class="grade-score">${f.score.toFixed(1)}/10 Â· ${f.pct}th %ile</div>
      <div style="color:var(--text-dim);font-size:11px;margin-top:6px">${f.trend}</div>`;
    grid.appendChild(card);
  });
}

function openDetail(factorKey, data){
  const panel=document.getElementById('detailPanel');
  const f=data.factors[factorKey];
  const icons={valuation:'ğŸ’µ',growth:'ğŸ“ˆ',profitability:'âš™ï¸',momentum:'ğŸš€',revisions:'ğŸ“Š'};
  document.getElementById('detailTitle').innerHTML=`${icons[factorKey]} ${f.desc} â€” <span class="grade-badge ${gradeColor(f.grade)}" style="font-size:1.1rem">${f.grade}</span>`;
  const tbody=document.getElementById('detailTable');
  tbody.innerHTML=f.metrics.map(([label,val,note,pct])=>`
    <tr>
      <td>${label}</td>
      <td>${val}</td>
      <td>${note}</td>
      <td>${pct!==null&&pct!==undefined?`
        <div class="mini-bar-wrap">
          <div class="mini-bar-track"><div class="mini-bar-fill" style="width:${pct}%;background:${barColor(pct)}"></div></div>
          <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);width:30px;text-align:right">${pct}%</span>
        </div>`:''}</td>
    </tr>`).join('');
  document.querySelectorAll('.factor-card').forEach(c=>c.classList.remove('active-card'));
  const cards=document.querySelectorAll('.factor-card');
  const idx=Object.keys(data.factors).indexOf(factorKey);
  if(cards[idx]) cards[idx].classList.add('active-card');
  panel.classList.add('visible');
  panel.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function closeDetail(){
  document.getElementById('detailPanel').classList.remove('visible');
  document.querySelectorAll('.factor-card').forEach(c=>c.classList.remove('active-card'));
}

function renderCompare(data){
  const sec=document.getElementById('compareSection');
  const c=data.compare;
  const peer=currentStock.sector?.includes('Semi')?'SOX':
             currentStock.sector?.includes('Tech')||currentStock.sector?.includes('Software')?'QQQ':'SPY';
  sec.innerHTML=`
    <h4>âš–ï¸ QUICK COMPARE â€” ${currentStock.ticker} vs Market</h4>
    <div class="compare-row">
      <div class="compare-stock" onclick="selectPreset('${currentStock.ticker}',null)">
        <div style="font-size:1.1rem;font-weight:800;color:#fff">${currentStock.ticker}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:2px">${(currentStock.name||'').split(' ').slice(0,3).join(' ')}</div>
        <div class="grade-badge ${gradeColor(numToGrade(currentStock.overallScore*2))}" style="font-size:1.4rem;margin-top:6px">Score: ${currentStock.overallScore.toFixed(1)}</div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:4px">${currentStock.recommendation}</div>
      </div>
      <div class="vs-badge">VS</div>
      <div class="compare-stock" onclick="selectPreset('${peer}',null)">
        <div style="font-size:1.1rem;font-weight:800;color:#fff">${peer}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:2px">Sector benchmark ETF</div>
        <div class="grade-badge gB" style="font-size:1.4rem;margin-top:6px">Click to analyze</div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:4px">Compare vs benchmark â†’</div>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRadar(data){
  const canvas=document.getElementById('radarCanvas');
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2+10,R=Math.min(W,H)/2-50;
  ctx.clearRect(0,0,W,H);
  const labels=['Valuation','Growth','Profitability','Momentum','Revisions'];
  const scores=Object.values(data.factors).map(f=>f.pct/100);
  const n=labels.length;
  const angle=i=>(i*2*Math.PI/n)-Math.PI/2;
  const pt=(i,r)=>[cx+r*Math.cos(angle(i)),cy+r*Math.sin(angle(i))];
  for(let ring=1;ring<=5;ring++){ctx.beginPath();for(let i=0;i<n;i++){const[x,y]=pt(i,R*ring/5);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}ctx.closePath();ctx.strokeStyle='#1f2640';ctx.lineWidth=1;ctx.stroke()}
  for(let i=0;i<n;i++){ctx.beginPath();ctx.moveTo(cx,cy);const[x,y]=pt(i,R);ctx.lineTo(x,y);ctx.strokeStyle='#1f2640';ctx.lineWidth=1;ctx.stroke()}
  ctx.beginPath();scores.forEach((s,i)=>{const[x,y]=pt(i,R*s);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});ctx.closePath();ctx.fillStyle='rgba(79,255,176,0.08)';ctx.fill();ctx.strokeStyle='#4fffb0';ctx.lineWidth=2;ctx.stroke();
  scores.forEach((s,i)=>{const[x,y]=pt(i,R*s);ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fillStyle='#4fffb0';ctx.fill()});
  ctx.fillStyle='#6b7799';ctx.font='11px Syne,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  labels.forEach((lbl,i)=>{const[x,y]=pt(i,R+22);ctx.fillText(lbl,x,y)});
}

function renderBars(data){
  const canvas=document.getElementById('barCanvas');
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  const names=['Valuation','Growth','Profitability','Momentum','Revisions'];
  const values=Object.values(data.factors).map(f=>f.pct);
  const barH=28,gap=16,startY=30,maxW=W-130;
  ctx.font='11px JetBrains Mono,monospace';ctx.textBaseline='middle';
  values.forEach((v,i)=>{
    const y=startY+i*(barH+gap);
    const w=(v/100)*maxW;
    const color=v>=75?'#4fffb0':v>=50?'#7dd8ff':v>=25?'#ff9248':'#ff4d6d';
    ctx.fillStyle='#6b7799';ctx.textAlign='left';ctx.font='11px JetBrains Mono,monospace';ctx.fillText(names[i],0,y+barH/2);
    ctx.fillStyle='#131829';ctx.beginPath();if(ctx.roundRect)ctx.roundRect(95,y,maxW,barH,4);else ctx.rect(95,y,maxW,barH);ctx.fill();
    if(w>0){ctx.fillStyle=color+'22';ctx.beginPath();if(ctx.roundRect)ctx.roundRect(95,y,w,barH,4);else ctx.rect(95,y,w,barH);ctx.fill();ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(95,y,w,barH,4);else ctx.rect(95,y,w,barH);ctx.stroke()}
    ctx.fillStyle=color;ctx.textAlign='right';ctx.font='12px JetBrains Mono,monospace';ctx.fillText(`${v}%`,95+maxW+32,y+barH/2);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MISC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter')analyzeStock();});

function showToast(msg){
  const ex=document.querySelector('.qe-toast');if(ex)ex.remove();
  const t=document.createElement('div');t.className='qe-toast';
  t.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px 20px;font-size:13px;color:var(--text);z-index:1002;box-shadow:0 8px 24px rgba(0,0,0,0.5);white-space:nowrap;animation:fadeUp 0.3s ease';
  t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3500);
}

// PWA
if('serviceWorker' in navigator){
  navigator.serviceWorker.getRegistrations().then(regs=>{regs.forEach(r=>r.unregister());});
}

let deferredInstallPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredInstallPrompt=e;
  if(!localStorage.getItem('qe-install-dismissed'))
    setTimeout(()=>document.getElementById('installBanner').classList.add('visible'),3000);
});
document.getElementById('btnInstall').addEventListener('click',async()=>{
  if(!deferredInstallPrompt)return;
  deferredInstallPrompt.prompt();
  const{outcome}=await deferredInstallPrompt.userChoice;
  deferredInstallPrompt=null;
  document.getElementById('installBanner').classList.remove('visible');
  if(outcome==='accepted')showToast('âœ… QuantEdge ÎµÎ³ÎºÎ±Ï„Î±ÏƒÏ„Î¬Î¸Î·ÎºÎµ!');
});
function dismissInstall(){document.getElementById('installBanner').classList.remove('visible');localStorage.setItem('qe-install-dismissed','1');}

function updateOnlineStatus(){
  const t=document.getElementById('offlineToast');
  navigator.onLine?t.classList.remove('visible'):t.classList.add('visible');
}
window.addEventListener('online',updateOnlineStatus);
window.addEventListener('offline',updateOnlineStatus);
updateOnlineStatus();

function bnav(tab,el){
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));el.classList.add('active');
  if(tab==='home')document.getElementById('searchInput').focus();
  else if(tab==='watchlist')showToast('â­ Watchlist â€” coming in v1.1');
  else if(tab==='compare'){const s=document.getElementById('compareSection');if(s)s.scrollIntoView({behavior:'smooth'});}
  else if(tab==='alerts')requestNotificationPermission();
}
async function requestNotificationPermission(){
  if(!('Notification' in window))return showToast('Notifications not supported');
  if(Notification.permission==='granted')return showToast('ğŸ”” Notifications Î®Î´Î· ÎµÎ½ÎµÏÎ³Î¬');
  const p=await Notification.requestPermission();
  if(p==='granted'){showToast('ğŸ”” Alerts ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎ±Î½!');new Notification('QuantEdge Alerts',{body:'Î˜Î± Î»Î±Î¼Î²Î¬Î½ÎµÎ¹Ï‚ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± price alerts.',icon:'/icons/icon-192.png'});}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',async()=>{
  // Featured chips first (no prices yet)
  renderFeaturedChips();
  loadTab('featured');

  // Preload SP500 list in background (silent)
  setTimeout(async()=>{
    try{
      const res=await fetchWithTimeout(`${BASE}/sp500_constituent?apikey=${FMP_KEY}`,12000);
      const json=await res.json();
      if(Array.isArray(json)&&json.length>0){
        sp500List=json.slice().sort((a,b)=>(a.symbol||'').localeCompare(b.symbol||''));
        tabCache['sp500']={data:sp500List, ts:Date.now()};
        console.log(`[QE] S&P 500 preloaded: ${sp500List.length} tickers`);
      }
    }catch(e){console.warn('[QE] SP500 preload fail:',e.message);}
  }, 2000);

  setTimeout(()=>document.getElementById('splash').classList.add('hidden'),1600);

  // Auto-analyze NVDA on load
  setTimeout(()=>{
    const chip=document.querySelector('[data-ticker="NVDA"]');
    selectPreset('NVDA', chip);
  }, 500);

  // URL param support
  const params=new URLSearchParams(window.location.search);
  const t=params.get('ticker');
  if(t) setTimeout(()=>selectPreset(t.toUpperCase(),null),1800);
});
</script>
</body>
</html>
